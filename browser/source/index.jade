extends layout



append head-title

    title Таски, таски, таски

append head-styles

    link(rel='stylesheet', href='styles/index.css')
    link(rel='stylesheet', href='components/aeTimeline/release/styles/bTimeline.css')

append head-scripts

    script(src='scripts/bApp.js')
    script(src='components/aeTimeline/release/scripts/bTimeline.min.js')
    script(src='components/aeTimeline/release/scripts/bTimelineInterval.min.js')
    script(src='scripts/index.js')



append body

    .b-app(b-app, ng-app="Caeruleus")

        div(ng-view)

        .b-app__view(ng-if="isRoute('schedule')", ng-controller="CaeruleusCtrl as schedule"): .b-app__view-inner

            .b-app__head
                .b-app__head-hero

                    //.row
                        .col.col-xs-12 12

                .b-app__head-menu

                    //.row
                        .col.col-xs-12 12

            .b-app__body: .b-app__body-page

                .row

                    .col.col-xs-3
                        .b-schedule__caption-title
                            button(ng-click="selectedIssue={};appDialogToggle('IssueFormDialog')") Add issue

                    .col.col-xs-9
                        .row
                            .col.col-xs-4
                                .b-schedule__caption-nav.b-schedule__caption-nav_prev(ng-if="schedule.mode=='week'")
                                    a(ng-href="#/?view=week&date={{getPrevWeekDate().toUTCString()}}") ←←←
                                .b-schedule__caption-nav.b-schedule__caption-nav_prev(ng-if="schedule.mode=='day'")
                                    a(ng-href="#/?view=day&date={{getPrevDayDate().toUTCString()}}") ←←
                                .b-schedule__caption-nav.b-schedule__caption-nav_prev(ng-if="schedule.mode=='hour'")
                                    a(ng-href="#/?view=hour&date={{getPrevHourDate().toUTCString()}}") ←
                            .col.col-xs-4
                                .b-schedule__caption-nav.b-schedule__caption-nav_mode
                                    a(href="#/?view=hour", ng-class="{_active:schedule.mode=='hour'}" style="padding: 0 15px;"): u HOUR
                                    a(href="#/?view=day", ng-class="{_active:schedule.mode=='day'}" style="padding: 0 15px;"): u DAY
                                    a(href="#/?view=week", ng-class="{_active:schedule.mode=='week'}" style="padding: 0 15px;"): u WEEK
                            .col.col-xs-4
                                .b-schedule__caption-nav.b-schedule__caption-nav_next(ng-if="schedule.mode=='hour'")
                                    a(ng-href="#/?view=hour&date={{getNextHourDate().toUTCString()}}") →
                                .b-schedule__caption-nav.b-schedule__caption-nav_next(ng-if="schedule.mode=='day'")
                                    a(ng-href="#/?view=day&date={{getNextDayDate().toUTCString()}}") →→
                                .b-schedule__caption-nav.b-schedule__caption-nav_next(ng-if="schedule.mode=='week'")
                                    a(ng-href="#/?view=week&date={{getNextWeekDate().toUTCString()}}") →→→
                        .row
                            .col.col-xs-12
                                .b-schedule__caption-interval {{getBeginDate()|date:'dd.MM.yyyy HH:mm'}} — {{getEndDate()|date:'dd.MM.yyyy HH:mm'}}

                .row

                    .b-schedule(ng-if="schedule.mode=='hour'||schedule.mode=='day'||schedule.mode=='week'", ng-class="{'b-schedule_hour':schedule.mode=='hour','b-schedule_day':schedule.mode=='day','b-schedule_week':schedule.mode=='week'}")

                        .b-schedule__head
                            .b-schedule__row

                                .b-schedule__col.b-schedule__col_title

                                .b-schedule__col.b-schedule__col_timeline
                                    .b-schedule-chunks
                                        .b-schedule-chunks__chunk(ng-repeat="chunk in chunks", ng-class="{'b-schedule-chunks__chunk_now':isNowInterval(chunk)}")
                                            div(ng-if="schedule.mode=='hour'")
                                                //b: small {{chunk.beginDate|date:'HH:mm'}}
                                                a() {{chunk.beginDate|date:'mm'}}
                                            div(ng-if="schedule.mode=='day'")
                                                //b: small {{chunk.beginDate|date:'HH:mm'}}
                                                a(ng-href="#/?view=hour&date={{chunk.beginDate.toUTCString()}}") {{chunk.beginDate|date:'HH'}}
                                            div(ng-if="schedule.mode=='week'")
                                                //b: small {{chunk.beginDate|date:'dd.MM'}}
                                                a(ng-href="#/?view=day&date={{chunk.beginDate.toUTCString()}}") {{chunk.beginDate|date:'dd'}}

                        .b-schedule__body(ng-repeat="issue in matchedIssues track by issue.guid")
                            .b-schedule__row

                                .b-schedule__col.b-schedule__col_title
                                    a(ng-click="pickIssue(issue); appDialogToggle('IssueViewDialog')"): u {{issue.title}}

                                .b-schedule__col.b-schedule__col_timeline

                                    .b-schedule-timeline(b-timeline, timeline-begin-date="getBeginDate()", timeline-end-date="getEndDate()", timeline-intervals="issue.intervals")
                                        div(b-timeline-template="interval", use="['bTimeline','interval']")
                                            div(b-timeline-interval)

                                                .b-timeline-interval-form(b-timeline-interval-template="form", use="['bTimelineInterval']")
                                                    .b-timeline-interval-form__main

                                                        .b-input-datetime(b-input-datetime)
                                                            .b-input-datetime__t

                                                                .b-input-datetime__t__c.b-input-datetime__t__c_input
                                                                    .b-input-date
                                                                        .b-input-date__btn.b-input-date__btn_next
                                                                            button(ng-click="incrBeginHours(bTimelineInterval.picked)") +
                                                                        .b-input-date__input
                                                                            input(readonly, value="{{bTimelineInterval.picked.beginDate|date:'HH'}}")
                                                                        .b-input-date__btn.b-input-date__btn_prev
                                                                            button(ng-click="decrBeginHours(bTimelineInterval.picked)") −

                                                                .b-input-datetime__t__c.b-input-datetime__t__c_label &#x3A;

                                                                .b-input-datetime__t__c.b-input-datetime__t__c_input
                                                                    .b-input-date
                                                                        .b-input-date__btn.b-input-date__btn_next
                                                                            button(ng-click="incrBeginMinutes(bTimelineInterval.picked)") +
                                                                        .b-input-date__input
                                                                            input(readonly, value="{{bTimelineInterval.picked.beginDate|date:'mm'}}")
                                                                        .b-input-date__btn.b-input-date__btn_prev
                                                                            button(ng-click="decrBeginMinutes(bTimelineInterval.picked)") −

                                                                .b-input-datetime__t__c.b-input-datetime__t__c_label &mdash;

                                                                .b-input-datetime__t__c.b-input-datetime__t__c_input
                                                                    .b-input-date
                                                                        .b-input-date__btn.b-input-date__btn_next
                                                                            button(ng-click="incrEndHours(bTimelineInterval.picked)") +
                                                                        .b-input-date__input
                                                                            input(readonly, value="{{bTimelineInterval.picked.endDate|date:'HH'}}")
                                                                        .b-input-date__btn.b-input-date__btn_prev
                                                                            button(ng-click="decrEndHours(bTimelineInterval.picked)") −

                                                                .b-input-datetime__t__c.b-input-datetime__t__c_label &#x3A;

                                                                .b-input-datetime__t__c.b-input-datetime__t__c_input
                                                                    .b-input-date
                                                                        .b-input-date__btn.b-input-date__btn_next
                                                                            button(ng-click="incrEndMinutes(bTimelineInterval.picked)") +
                                                                        .b-input-date__input
                                                                            input(readonly, value="{{bTimelineInterval.picked.endDate|date:'mm'}}")
                                                                        .b-input-date__btn.b-input-date__btn_prev
                                                                            button(ng-click="decrEndMinutes(bTimelineInterval.picked)") −

                                                        button(ng-click="save(bTimelineInterval.picked, interval); bTimelineInterval.unpick()", ng-disabled="bTimelineInterval.isPickedPristine()") save interval
                                                        button(ng-click="bTimelineInterval.unpick()") close

                                    .b-schedule-chunks
                                        .b-schedule-chunks__chunk(ng-repeat="chunk in chunks")

                .row
                    .col.col-xs-12  
                    .col.col-xs-12
                        ul.b-tags
                            li.b-tags__tag(ng-repeat="tag in tagsIdx")
                                a.b-tag(ng-class="{'b-tag__active':selectedTags[tag.name]}" ng-click="selectTag(tag)||unselectTag(tag)") {{tag.name}}
                                span(ng-if="!$last") ,

                .app-dialog(b-app-dialog="IssueFormDialog", ng-form="IssueForm", ng-controller="IssueFormCtrl")

                    .app-dialog__head
                        .app-dialog__heading New issue

                    .app-dialog__body
                        .row

                            .col.col-xs-12.col-md-4.col-md-push-8
                                .row
                                    .col.col-xs-12
                                        span(ng-repeat="tag in selectedIssueTags")
                                            a() {{tag.name}}
                                            span(ng-if="!$last") , 

                            fieldset.app-form.col.col-xs-12.col-md-8.col-md-pull-4
                                .row
                                    label.col.col-xs-3.col-lg-2(required) Title
                                    input.col.col-xs-9.col-lg-10(name="title", ng-model="selectedIssue.title", required)
                                .row
                                    label.col.col-xs-3.col-lg-2() Tags
                                    input.col.col-xs-9.col-lg-10(name="tags", ng-model="selectedIssue.tags", ng-list)
                                .row
                                    label.col.col-xs-3.col-lg-2() Details
                                    textarea.col.col-xs-9.col-lg-10(name="content", ng-model="selectedIssue.content", rows="{{((selectedIssue.content.split('\n').length + 1) > 7 && selectedIssue.content.split('\n').length + 1) || 7}}")

                    .app-dialog__foot
                        .row
                            .col.col-xs-12.col-md-8
                                .row
                                    .col.col-xs-3.col-lg-2  
                                    button.col.col-xs-5.col-lg-5(ng-click="saveIssue(selectedIssue, IssueForm)" ng-disabled="IssueForm.$invalid") Submit new issue

                .app-dialog(b-app-dialog="IssueViewDialog", ng-form="IssueForm", ng-controller="IssueFormCtrl")

                    .app-dialog__head
                        .app-dialog__heading Issue 
                            button(ng-show="'edit'==AppDialog.mode", ng-click="AppDialog.mode='view'") view
                            button(ng-show="'view'==AppDialog.mode", ng-click="AppDialog.mode='edit'") edit
                            button(ng-show="'edit'==AppDialog.mode", ng-click="deleteIssue(selectedIssue)") delete
                            button(ng-if="!selectedIssue.startedAt", ng-click="startWork(selectedIssue)") ► Start work
                            button(ng-if="selectedIssue.startedAt", ng-click="stopWork(selectedIssue)") ■ Stop work


                    .app-dialog__body(ng-show="'view'==AppDialog.mode")
                        .row

                            .col.col-xs-12.col-md-4.col-md-push-8
                                .row
                                    .col.col-xs-12
                                        span(ng-repeat="tag in selectedIssueTags")
                                            a() {{tag.name}}
                                            span(ng-if="!$last") , 

                            .app-form.col.col-xs-12.col-md-8.col-md-pull-4
                                .row
                                    .col.col-xs-3.col-lg-2  
                                    div.col.col-xs-9.col-lg-10
                                        strong {{selectedIssue.title}}
                                .row
                                    label.col.col-xs-3.col-lg-2  
                                    div.col.col-xs-9.col-lg-10
                                        span {{selectedIssue.content}}

                    .app-dialog__body(ng-show="'edit'==AppDialog.mode")
                        .row

                            .col.col-xs-12.col-md-4.col-md-push-8
                                .row
                                    .col.col-xs-12
                                        span(ng-repeat="tag in selectedIssueTags")
                                            a() {{tag.name}}
                                            span(ng-if="!$last") , 

                            fieldset.app-form.col.col-xs-12.col-md-8.col-md-pull-4
                                .row
                                    label.col.col-xs-3.col-lg-2(required) Title
                                    input.col.col-xs-9.col-lg-10(name="title", ng-model="selectedIssue.title", required)
                                .row
                                    label.col.col-xs-3.col-lg-2() Tags
                                    input.col.col-xs-9.col-lg-10(name="tags", ng-model="selectedIssue.tags", ng-list)
                                .row
                                    label.col.col-xs-3.col-lg-2() Details
                                    textarea.col.col-xs-9.col-lg-10(name="content", ng-model="selectedIssue.content", rows="{{((selectedIssue.content.split('\n').length + 1) > 7 && selectedIssue.content.split('\n').length + 1) || 7}}")


                    .app-dialog__foot(ng-show="'edit'==AppDialog.mode||IssueForm.$dirty")
                        .row
                            .col.col-xs-12.col-md-8
                                .row
                                    .col.col-xs-3.col-lg-2  
                                    button.col.col-xs-5.col-lg-6(ng-click="saveIssue(selectedIssue, IssueForm)" ng-disabled="IssueForm.$invalid") Save issue
                                    button.col.col-xs-2.col-lg-2(ng-click="mode='view';") Cancel
                                    button.col.col-xs-2.col-lg-2(ng-click="mode='view';AppDialog.resolve(false)") Close

        .app-overlay(ng-repeat="(key, dialog) in dialogs", ng-if="dialog.$shown", ng-controller="AppDialogCtrl as AppDialog")
            .app-overlay__bg(ng-click="AppDialog.resolve(false)")
            .app-overlay__dialog(b-app-dialog-transclude="{{key}}")
